<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NyaySarthi AI: Demystify Legal Documents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">
    <script>
        // Set theme on initial load to prevent FOUC (Flash of Unstyled Content)
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .mesh-gradient {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: 200% 200%;
            background-image: radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 1) 0px, transparent 50%), radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 1) 0px, transparent 50%), radial-gradient(at 52% 99%, hsla(355, 98%, 76%, 1) 0px, transparent 50%), radial-gradient(at 10% 29%, hsla(256, 96%, 68%, 1) 0px, transparent 50%), radial-gradient(at 97% 96%, hsla(38, 60%, 74%, 1) 0px, transparent 50%), radial-gradient(at 33% 50%, hsla(222, 67%, 73%, 1) 0px, transparent 50%), radial-gradient(at 79% 53%, hsla(343, 68%, 79%, 1) 0px, transparent 50%);
            animation: gradient-move 15s ease infinite alternate;
        }
        .dark .mesh-gradient {
            background-image: radial-gradient(at 27% 37%, hsla(215, 60%, 25%, 1) 0px, transparent 50%), radial-gradient(at 97% 21%, hsla(125, 60%, 20%, 1) 0px, transparent 50%), radial-gradient(at 52% 99%, hsla(355, 60%, 25%, 1) 0px, transparent 50%), radial-gradient(at 10% 29%, hsla(256, 60%, 25%, 1) 0px, transparent 50%), radial-gradient(at 97% 96%, hsla(38, 60%, 20%, 1) 0px, transparent 50%), radial-gradient(at 33% 50%, hsla(222, 60%, 20%, 1) 0px, transparent 50%), radial-gradient(at 79% 53%, hsla(343, 60%, 25%, 1) 0px, transparent 50%);
        }
        @keyframes gradient-move {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .chat-bubble-user { background-color: #2563eb; color: white; border-radius: 1.5rem 1.5rem 0.25rem 1.5rem; }
        .dark .chat-bubble-user { background-color: #3b82f6; }
        .chat-bubble-ai { background-color: #e5e7eb; color: #1f2937; border-radius: 1.5rem 1.5rem 1.5rem 0.25rem; }
        .dark .chat-bubble-ai { background-color: #374151; color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        .skeleton-loader { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        /* Animated Theme Toggle */
        #theme-toggle .sun, #theme-toggle .moon { transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease-in-out; }
        #theme-toggle .moon { transform: scale(0); opacity: 0; }
        .dark #theme-toggle .sun { transform: rotate(45deg) scale(0); opacity: 0; }
        .dark #theme-toggle .moon { transform: scale(1) rotate(0); opacity: 1; }

        /* Splash Screen */
        #splash-screen {
            transition: opacity 0.5s ease-out;
        }
        #splash-screen.fade-out {
            opacity: 0;
        }
        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        #splash-logo {
            animation: logo-pulse 2s ease-in-out infinite;
        }
        
        /* History Panel */
        #history-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #history-panel.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">
    
    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900">
        <div id="splash-logo">
             <svg class="w-48 h-48" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="logoTitleSplash">
                <title id="logoTitleSplash">NyaySarathi Logo - Demystify Legal Documents</title>
                <g transform="translate(0, -5)">
                    <g>
                        <path d="M 100,20 A 60 60 0 1 1 40,100" fill="none" stroke="#0d3d56" stroke-width="6" stroke-linecap="round"/>
                        <path d="M 100,20 A 60 60 0 1 0 160,100" fill="none" stroke="#48a9a6" stroke-width="6" stroke-linecap="round"/>
                    </g>
                    <g>
                        <path d="M 50 45 H 150" stroke="#f2a104" stroke-width="3.5" stroke-linecap="round"/>
                        <path d="M 100 45 V 30" stroke="#0d3d56" stroke-width="3.5"/>
                        <circle cx="100" cy="27" r="3" fill="#f2a104"/>
                        <g>
                            <path d="M 60 45 C 55 55, 55 65, 60 75" fill="none" stroke="#0d3d56" stroke-width="2"/>
                            <path d="M 80 45 C 85 55, 85 65, 80 75" fill="none" stroke="#0d3d56" stroke-width="2"/>
                            <path d="M 55 75 Q 70 85, 85 75" fill="#0d3d56"/>
                            <text x="70" y="77" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#ffffff">?</text>
                        </g>
                        <g>
                            <path d="M 120 45 C 115 55, 115 65, 120 75" fill="none" stroke="#f2a104" stroke-width="2"/>
                            <path d="M 140 45 C 145 55, 145 65, 140 75" fill="none" stroke="#f2a104" stroke-width="2"/>
                            <path d="M 115 75 Q 130 85, 145 75" fill="#f2a104"/>
                        </g>
                    </g>
                    <g>
                        <path d="M 70 110 C 70 90, 90 85, 100 85 C 110 85, 130 90, 130 110 L 130 50 L 70 50 Z" fill="#0d3d56"/>
                        <path d="M 100 52 V 108" stroke="#48a9a6" stroke-width="2.5"/>
                        <g stroke="#ffffff" stroke-width="1.5" stroke-opacity="0.7">
                            <path d="M 78 65 H 95"/><path d="M 78 72 H 95"/><path d="M 78 79 H 95"/>
                            <path d="M 105 65 H 122"/><path d="M 105 72 H 122"/><path d="M 105 79 H 122"/>
                        </g>
                    </g>
                    <g transform="rotate(-30 95 90)">
                        <circle cx="95" cy="90" r="8" fill="rgba(255,255,255,0.2)" stroke="#48a9a6" stroke-width="2.5"/>
                        <line x1="102" y1="97" x2="108" y2="103" stroke="#48a9a6" stroke-width="3" stroke-linecap="round"/>
                    </g>
                    <g>
                        <path d="M 115 80 C 130 70, 145 60, 150 50" fill="none" stroke="#f2a104" stroke-width="3.5" stroke-linecap="round"/>
                        <path d="M 144 55 L 150 50 L 145 45" fill="none" stroke="#f2a104" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                </g>
                <g text-anchor="middle" font-family="Poppins, Arial, sans-serif">
                    <text y="170" x="100" font-size="22" font-weight="600">
                        <tspan fill="#0d3d56">Nyay</tspan><tspan fill="#48a9a6">Sarathi</tspan>
                    </text>
                    <text y="185" x="100" font-size="10" font-weight="500" fill="#555555" letter-spacing="0.5">DEMYSTIFY LEGAL DOCUMENTS</text>
                </g>
            </svg>
        </div>
        <div class="flex items-center text-gray-500 dark:text-gray-400 mt-6">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <p class="text-sm">Secured by Claritas Tech</p>
        </div>
    </div>

    <!-- History Panel -->
    <div id="history-panel" class="fixed top-0 left-0 w-full max-w-sm h-full bg-white dark:bg-gray-800 shadow-2xl z-40 p-6 flex flex-col">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white" data-lang-key="historyTitle">Analysis History</h2>
            <button id="close-history-btn" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">&times;</button>
        </div>
        <div id="history-list" class="flex-grow overflow-y-auto pr-2 space-y-3">
            <!-- History items will be injected here -->
        </div>
        <button id="clear-history-btn" class="mt-4 w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 transition-colors" data-lang-key="clearHistory">Clear History</button>
    </div>
    <div id="history-overlay" class="fixed inset-0 bg-black/50 z-30 hidden"></div>

    <div class="mesh-gradient"></div>
    <div class="min-h-screen flex flex-col items-center justify-center p-4 relative">
        <div class="w-full max-w-7xl mx-auto bg-white/60 dark:bg-gray-900/60 backdrop-blur-2xl rounded-2xl shadow-2xl flex flex-col md:flex-row border border-white/30 dark:border-gray-700/50 overflow-hidden md:h-auto">
            
            <!-- Left Panel: Document Input -->
            <div class="w-full md:w-1/2 p-4 sm:p-8 flex flex-col border-r border-gray-200/50 dark:border-gray-700/50 md:overflow-y-auto">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                    <div class="flex items-center space-x-3">
                         <button id="history-btn" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 rounded-lg p-2.5">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                         </button>
                        <svg class="w-12 h-12 hidden sm:block" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="logoTitleMain">
                            <g transform="translate(0, -5)">
                                <g>
                                    <path d="M 100,20 A 60 60 0 1 1 40,100" fill="none" stroke="#0d3d56" stroke-width="6" stroke-linecap="round"/>
                                    <path d="M 100,20 A 60 60 0 1 0 160,100" fill="none" stroke="#48a9a6" stroke-width="6" stroke-linecap="round"/>
                                </g>
                                <g>
                                    <path d="M 50 45 H 150" stroke="#f2a104" stroke-width="3.5" stroke-linecap="round"/>
                                    <path d="M 100 45 V 30" stroke="#0d3d56" stroke-width="3.5"/>
                                    <circle cx="100" cy="27" r="3" fill="#f2a104"/>
                                </g>
                                <g>
                                    <path d="M 70 110 C 70 90, 90 85, 100 85 C 110 85, 130 90, 130 110 L 130 50 L 70 50 Z" fill="#0d3d56"/>
                                    <path d="M 100 52 V 108" stroke="#48a9a6" stroke-width="2.5"/>
                                    <g stroke="#ffffff" stroke-width="1.5" stroke-opacity="0.7">
                                        <path d="M 78 65 H 95"/><path d="M 78 72 H 95"/><path d="M 78 79 H 95"/>
                                        <path d="M 105 65 H 122"/><path d="M 105 72 H 122"/><path d="M 105 79 H 122"/>
                                    </g>
                                </g>
                                <g transform="rotate(-30 95 90)">
                                    <circle cx="95" cy="90" r="8" fill="rgba(255,255,255,0.2)" stroke="#48a9a6" stroke-width="2.5"/>
                                    <line x1="102" y1="97" x2="108" y2="103" stroke="#48a9a6" stroke-width="3" stroke-linecap="round"/>
                                </g>
                            </g>
                           </g>
                           <g text-anchor="middle" font-family="Poppins, Arial, sans-serif">
                                <text y="170" x="100" font-size="22" font-weight="600">
                                    <tspan fill="#0d3d56">Nyay</tspan><tspan fill="#48a9a6">Sarathi</tspan>
                                </text>
                            </g>
                        </svg>
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 dark:text-white" data-lang-key="title">NyaySarthi AI</h1>
                            <p class="text-gray-600 dark:text-gray-400 mt-1 text-sm" data-lang-key="subtitle">Your AI legal document assistant.</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 self-end sm:self-center">
                        <select id="languageSelector" class="bg-white/50 dark:bg-gray-800/50 border border-gray-300/50 dark:border-gray-700/50 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 block p-2 transition">
                            <option value="en">English</option>
                            <option value="hi">हिन्दी</option>
                            <option value="bn">বাংলা</option>
                            <option value="mr">मराठी</option>
                            <option value="ta">தமிழ்</option>
                            <option value="ml">മലയാളം</option>
                        </select>
                        <button id="theme-toggle" type="button" class="relative text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 rounded-lg text-sm p-2.5 w-10 h-10 flex items-center justify-center transition-colors">
                            <svg class="sun w-6 h-6 absolute" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a5 5 0 100-10 5 5 0 000 10z"></path></svg>
                            <svg class="moon w-6 h-6 absolute" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-center text-gray-500 dark:text-gray-500 mb-4 italic">“पूर्णं ज्ञानं श्रेयः, पछ्चात्तापो दुःखहेतुः।”</p>
                <div class="my-4 border-t border-b border-gray-200/50 dark:border-gray-700/50 py-4 space-y-4">
                    <ul class="space-y-3 text-gray-700 dark:text-gray-300 text-sm">
                        <li class="flex items-center space-x-3"><svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span data-lang-key="feature1">Instant Summaries</span></li>
                        <li class="flex items-center space-x-3"><svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h1m8 4h-2"></path></svg><span data-lang-key="feature2">Complex Clause Explanations</span></li>
                        <li class="flex items-center space-x-3"><svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><span data-lang-key="feature3">Interactive Q&A</span></li>
                    </ul>
                    <div class="flex items-start space-x-3 text-xs text-gray-500 dark:text-gray-400 p-3 bg-gray-500/10 rounded-lg"><svg class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg><p data-lang-key="security">Secure & Private: Your documents are processed securely and are never stored on our servers.</p></div>
                </div>
                <div class="relative flex-grow h-48 sm:h-auto">
                    <button id="clearBtn" title="Clear Text" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors z-10"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    <textarea id="documentInput" class="w-full h-full p-4 border border-gray-300/50 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-300 text-sm bg-white/50 dark:bg-gray-800/50 dark:border-gray-700/50 dark:placeholder-gray-400 dark:text-white" data-lang-placeholder="pastePlaceholder"></textarea>
                </div>
                <div class="flex items-center justify-center space-x-6 mt-4">
                     <label for="fileInput" class="cursor-pointer flex items-center space-x-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span data-lang-key="uploadFile">Upload File(s)</span>
                    </label>
                    <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf,.png,.jpg,.jpeg" multiple>
                    <button id="cameraBtn" class="flex items-center space-x-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span data-lang-key="useCamera">Use Camera</span>
                    </button>
                    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment">
                </div>
                 <div id="fileListContainer" class="mt-4 space-y-2"></div>
                 <p id="fileStatus" class="mt-2 text-sm text-center text-gray-600 dark:text-gray-400"></p>
                <button id="demystifyBtn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105 duration-300 shadow-lg dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800 flex items-center justify-center space-x-2 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:scale-100 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    <span data-lang-key="demystifyBtn">Demystify Document</span>
                </button>
                <p class="text-center text-xs text-gray-400 dark:text-gray-500 mt-6">Made by Claritas Tech</p>
            </div>

            <!-- Right Panel: AI Output -->
            <div class="w-full md:w-1/2 p-4 sm:p-8 flex flex-col bg-gray-50/60 dark:bg-black/20">
                <div id="outputContainer" class="flex-grow overflow-y-auto">
                    <div id="initialState" class="flex flex-col items-center justify-center h-full text-center">
                        <svg class="w-16 h-16 text-gray-300 dark:text-gray-700 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <h2 class="text-xl font-semibold text-gray-500 dark:text-gray-400" data-lang-key="initialTitle"></h2>
                        <p class="text-gray-400 dark:text-gray-500 mt-1" data-lang-key="initialSubtitle"></p>
                    </div>
                    <div id="loadingState" class="hidden"><div class="space-y-6"><div class="skeleton-loader bg-gray-200 dark:bg-gray-800 h-8 w-1/3 rounded-lg"></div><div class="skeleton-loader bg-gray-200 dark:bg-gray-800 h-20 w-full rounded-lg"></div><div class="skeleton-loader bg-gray-200 dark:bg-gray-800 h-8 w-1/2 rounded-lg"></div><div class="skeleton-loader bg-gray-200 dark:bg-gray-800 h-16 w-full rounded-lg"></div><div class="skeleton-loader bg-gray-200 dark:bg-gray-800 h-16 w-full rounded-lg"></div></div></div>
                    <div id="resultState" class="hidden flex flex-col space-y-6 pr-4">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                             <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 dark:text-white" data-lang-key="analysisReport">Analysis Report</h2>
                             <div id="export-buttons" class="flex items-center space-x-2"></div>
                        </div>
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            <div id="contractHealthSection">
                                <h2 class="text-xl font-bold mb-2 text-gray-800 dark:text-gray-200" data-lang-key="healthTitle"></h2>
                                <div id="healthCard" class="p-4 rounded-lg flex items-start space-x-4">
                                    <div id="healthIcon" class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full mt-1"></div>
                                    <div>
                                        <p id="healthRating" class="font-bold text-xl"></p>
                                        <p id="healthJustification" class="text-sm"></p>
                                    </div>
                                </div>
                            </div>
                             <div id="clauseSeveritySection">
                                <div class="flex items-baseline space-x-3">
                                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200" data-lang-key="severityTitle"></h2>
                                    <div id="severityCard" class="flex items-center space-x-3">
                                        <!-- Severity counts will be injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="nextStepsSection"><h2 class="text-2xl font-bold mb-3 text-green-700 dark:text-green-400" data-lang-key="nextStepsTitle"></h2><div id="nextStepsContainer" class="space-y-3"></div></div>
                        <div id="summarySection"><h2 class="text-2xl font-bold mb-3 text-blue-700 dark:text-blue-400" data-lang-key="summaryTitle"></h2><p id="summaryText" class="text-gray-600 dark:text-gray-300 leading-relaxed bg-blue-500/10 p-4 rounded-lg"></p></div>
                        <div id="clausesSection"><h2 class="text-2xl font-bold mb-3 text-purple-700 dark:text-purple-400" data-lang-key="clausesTitle"></h2><div id="clausesContainer" class="space-y-4"></div></div>
                    </div>
                </div>
                <div id="chatSection" class="mt-6 border-t border-gray-200/50 dark:border-gray-700/50 pt-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4" data-lang-key="chatTitle"></h3>
                    <div id="chatHistory" class="h-40 overflow-y-auto mb-4 space-y-4 p-2"></div>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="chatInput" data-lang-placeholder="chatPlaceholder" class="flex-grow p-3 border border-gray-300/50 dark:border-gray-700/50 bg-white/50 dark:bg-gray-800/50 dark:text-white rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-300">
                        <button id="sendBtn" class="bg-blue-500 text-white rounded-full p-3 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 transition-transform transform hover:scale-110 duration-300 flex-shrink-0"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg></button>
                    </div>
                </div>
                <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg dark:bg-red-900/20 dark:border-red-500/30 dark:text-red-400"><p><strong>Error:</strong> <span id="errorText"></span></p></div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const demystifyBtn = document.getElementById('demystifyBtn');
        const documentInput = document.getElementById('documentInput');
        const initialState = document.getElementById('initialState');
        const loadingState = document.getElementById('loadingState');
        const resultState = document.getElementById('resultState');
        const summaryText = document.getElementById('summaryText');
        const clausesContainer = document.getElementById('clausesContainer');
        const chatSection = document.getElementById('chatSection');
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const languageSelector = document.getElementById('languageSelector');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const cameraBtn = document.getElementById('cameraBtn');
        const clearBtn = document.getElementById('clearBtn');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileStatus = document.getElementById('fileStatus');
        const splashScreen = document.getElementById('splash-screen');
        const contractHealthSection = document.getElementById('contractHealthSection');
        const healthCard = document.getElementById('healthCard');
        const healthIcon = document.getElementById('healthIcon');
        const healthRating = document.getElementById('healthRating');
        const healthJustification = document.getElementById('healthJustification');
        const nextStepsContainer = document.getElementById('nextStepsContainer');
        const exportButtonsContainer = document.getElementById('export-buttons');
        const historyBtn = document.getElementById('history-btn');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const historyPanel = document.getElementById('history-panel');
        const historyOverlay = document.getElementById('history-overlay');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        // --- State and Config ---
        let currentAnalysis = {};
        let originalDocument = '';
        let selectedFiles = [];
        let currentLanguage = localStorage.getItem('language') || 'en';
        
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const translations = {
            en: { title: "NyaySarthi AI", subtitle: "Your AI legal document assistant.", pastePlaceholder: "Paste your complex legal document here, or select files below.", uploadFile: "Upload File(s)", useCamera: "Use Camera", demystifyBtn: "Demystify Document", initialTitle: "Your simplified summary will appear here.", initialSubtitle: "You can also ask follow-up questions.", summaryTitle: "Document Summary", clausesTitle: "Key Clause Explanations", chatTitle: "Ask a Question", chatPlaceholder: "Ask about specific terms, dates, or obligations...", clear: "Clear", errorPasteDoc: "Please paste a document or select at least one file.", errorFileSupport: "Unsupported file type. Please upload a .txt, .pdf, .png, .jpg or .jpeg file.", errorCameraSupport: "Camera support is not yet implemented. Please select a file.", errorAIGeneric: "I'm sorry, I couldn't process that. Please try again.", noSummary: "No summary could be generated.", noClauses: "No specific clauses were highlighted by the AI.", feature1: "Instant Summaries", feature2: "Complex Clause Explanations", feature3: "Interactive Q&A", security: "Secure & Private: Your documents are processed securely and are never stored on our servers.", errorPDFParse: "Could not read text from the PDF file. It may be an image-only PDF or corrupted.", langInstruction: "Provide the entire response in English.", fileReady: (count) => `${count} file(s) ready for analysis. You can proceed.`, healthTitle: "Contract Health", reExplain: "Re-explain", askWhy: "Ask Why", emailClause: "Email", severityTitle: "Clause Severity", severityHigh: "High", severityMedium: "Medium", severityLow: "Low", nextStepsTitle: "Actionable Next Steps", analysisReport: "Analysis Report", copyReport: "Copy", emailReport: "Share", historyTitle: "Analysis History", noHistory: "No history yet. Analyze a document to get started.", clearHistory: "Clear History", clearHistoryConfirm: "Are you sure you want to clear all history?" },
            hi: { title: "न्यायसारथी एआई", subtitle: "आपका एआई कानूनी दस्तावेज़ सहायक।", pastePlaceholder: "अपना जटिल कानूनी दस्तावेज़ यहाँ पेस्ट करें, या नीचे फ़ाइलें चुनें।", uploadFile: "फ़ाइलें अपलोड करें", useCamera: "कैमरे का प्रयोग करें", demystifyBtn: "दस्तावेज़ को सरल बनाएं", initialTitle: "आपका सरलीकृत सारांश यहाँ दिखाई देगा।", initialSubtitle: "आप अतिरिक्त प्रश्न भी पूछ सकेंगे।", summaryTitle: "दस्तावेज़ सारांश", clausesTitle: "मुख्य धारा स्पष्टीकरण", chatTitle: "एक प्रश्न पूछें", chatPlaceholder: "विशिष्ट शब्दों, तिथियों या दायित्वों के बारे में पूछें...", clear: "साफ़ करें", errorPasteDoc: "कृपया एक दस्तावेज़ पेस्ट करें या कम से कम एक फ़ाइल चुनें।", errorFileSupport: "असमर्थित फ़ाइल प्रकार। कृपया .txt, .pdf, .png, .jpg या .jpeg फ़ाइल अपलोड करें।", errorCameraSupport: "कैमरा समर्थन अभी तक लागू नहीं किया गया है। कृपया एक फ़ाइल चुनें।", errorAIGeneric: "मुझे क्षमा करें, मैं उसे संसाधित नहीं कर सका। कृपया पुनः प्रयास करें।", noSummary: "कोई सारांश उत्पन्न नहीं किया जा सका।", noClauses: "एआई द्वारा कोई विशिष्ट धारा हाइलाइट नहीं किया गया था।", feature1: "तुरंत सारांश", feature2: "जटिल धारा स्पष्टीकरण", feature3: "इंटरैक्टिव प्रश्नोत्तर", security: "सुरक्षित और निजी: आपके दस्तावेज़ कभी संग्रहीत नहीं किए जाते हैं।", errorPDFParse: "PDF फ़ाइल से टेक्स्ट नहीं पढ़ा जा सका। यह केवल-छवि PDF या दूषित हो सकती है।", langInstruction: "Provide the entire response in Hindi.", fileReady: (count) => `विश्लेषण के लिए ${count} फ़ाइल(लें) तैयार हैं। आप आगे बढ़ सकते हैं।`, healthTitle: "अनुबंध स्वास्थ्य", reExplain: "पुनः समझाएं", askWhy: "क्यों पूछें", emailClause: "ईमेल करें", severityTitle: "धारा की गंभीरता", severityHigh: "उच्च", severityMedium: "मध्यम", severityLow: "कम", nextStepsTitle: "अगले कदम", analysisReport: "विश्लेषण रिपोर्ट", copyReport: "कॉपी", emailReport: "शेयर", historyTitle: "विश्लेषण इतिहास", noHistory: "अभी तक कोई इतिहास नहीं है। आरंभ करने के लिए एक दस्तावेज़ का विश्लेषण करें।", clearHistory: "इतिहास साफ़ करें", clearHistoryConfirm: "क्या आप वाकई सारा इतिहास साफ़ करना चाहते हैं?" },
            bn: { title: " ন্যায়সারথি এআই", subtitle: "আপনার এআই আইনি নথি सहायक।", pastePlaceholder: "আপনার জটিল আইনি নথি এখানে পেস্ট করুন, অথবা নীচে ফাইল নির্বাচন করুন।", uploadFile: "ফাইল আপলোড করুন", useCamera: "ক্যামেরা ব্যবহার করুন", demystifyBtn: "নথিটি ডেমিস্টিফাই করুন", initialTitle: "আপনার সরলীকৃত সারসংক্ষেপ এখানে উপস্থিত হবে।", initialSubtitle: "আপনি ফলো-আপ প্রশ্নও করতে পারেন।", summaryTitle: "নথির সারসংক্ষেপ", clausesTitle: "মূল ধারার ব্যাখ্যা", chatTitle: "একটি প্রশ্ন জিজ্ঞাসা করুন", chatPlaceholder: " নির্দিষ্ট শর্তাবলী, তারিখ বা বাধ্যবাধকতা সম্পর্কে জিজ্ঞাসা করুন...", clear: "পরিষ্কার করুন", errorPasteDoc: "অনুগ্রহ করে একটি নথি পেস্ট করুন বা অন্তত একটি ফাইল নির্বাচন করুন।", errorFileSupport: "অসমর্থিত ফাইলের ধরন। অনুগ্রহ করে .txt, .pdf, .png, .jpg বা .jpeg ফাইল আপলোড করুন।", errorCameraSupport: "ক্যামেরা সমর্থন এখনও প্রয়োগ করা হয়নি। অনুগ্রহ করে একটি ফাইল নির্বাচন করুন।", errorAIGeneric: "আমি দুঃখিত, আমি এটি প্রক্রিয়া করতে পারিনি। অনুগ্রহ করে আবার চেষ্টা করুন।", noSummary: "কোনো সারসংক্ষেপ তৈরি করা যায়নি।", noClauses: "এআই দ্বারা কোনো নির্দিষ্ট ধারা হাইলাইট করা হয়নি।", feature1: "তাত্ক্ষণিক সারসংক্ষেপ", feature2: "জটিল ধারার ব্যাখ্যা", feature3: "ইন্টারেক্টিভ প্রশ্নোত্তর", security: "সুরক্ষিত এবং ব্যক্তিগত: আপনার নথিগুলি সুরক্ষিতভাবে প্রক্রিয়া করা হয় এবং আমাদের সার্ভারে কখনও সংরক্ষণ করা হয় না।", errorPDFParse: "পিডিএফ ফাইল থেকে পাঠ্য পড়া যায়নি। এটি কেবল-ছবি পিডিএফ বা দূষিত হতে পারে।", langInstruction: "Provide the entire response in Bengali.", fileReady: (count) => `বিশ্লেষণের জন্য ${count}টি ফাইল প্রস্তুত। আপনি এগিয়ে যেতে পারেন।`, healthTitle: "চুক্তি স্বাস্থ্য", reExplain: "পুনরায় ব্যাখ্যা করুন", askWhy: "কেন জিজ্ঞাসা করুন", emailClause: "ইমেল করুন", severityTitle: "ধারার তীব্রতা", severityHigh: "উচ্চ", severityMedium: "মাঝারি", severityLow: "নিম্ন", nextStepsTitle: "পরবর্তী পদক্ষেপ", analysisReport: "বিশ্লেষণ প্রতিবেদন", copyReport: "অনুলিপি", emailReport: "শেয়ার", historyTitle: "বিশ্লেষণ ইতিহাস", noHistory: "এখনও কোন ইতিহাস নেই। শুরু করতে একটি নথি বিশ্লেষণ করুন।", clearHistory: "ইতিহাস পরিষ্কার করুন", clearHistoryConfirm: "আপনি কি নিশ্চিত যে আপনি সমস্ত ইতিহাস পরিষ্কার করতে চান?" },
            mr: { title: "न्यायसारथी एआय", subtitle: "तुमचा एआय कायदेशीर ਦਸਤਾਵੇਜ सहाय्यक।", pastePlaceholder: "तुमचा गुंतागुंतीचा कायदेशीर दस्तऐवज येथे पेस्ट करा, किंवा खालील फाइल निवडा.", uploadFile: "दस्तऐवज अपलोड करा", useCamera: "कॅमेरा वापरा", demystifyBtn: "दस्तऐवज डिमिस्टिफाय करा", initialTitle: "तुमचा सोपा सारांश येथे दिसेल.", initialSubtitle: "तुम्ही ফলো-अप প্রশ্ন देखील विचारू शकता.", summaryTitle: "दस्तऐवज सारांश", clausesTitle: "मुख्य कलमांचे स्पष्टीकरण", chatTitle: "प्रश्न विचारा", chatPlaceholder: "विशिष्ट अटी, तारखा किंवा जबाबदाऱ्यांबद्दल विचारा...", clear: "साफ करा", errorPasteDoc: "कृपया এক দস্তऐवज पेस्ट करा किंवा किमान এক फाईल निवडा।", errorFileSupport: "असमर्थित फाइल प्रकार. कृपया .txt, .pdf, .png, .jpg বা .jpeg फाइल अपलोड करा.", errorCameraSupport: "कॅमेरा समर्थन अद्याप लागू केलेले नाही. कृपया एक फाइल निवडा.", errorAIGeneric: "मला माफ करा, मी ते प्रक्रिया करू शकलो नाही. कृपया पुन्हा प्रयत्न करा.", noSummary: "कोणताही सारांश तयार होऊ शकला नाही.", noClauses: "एआयद्वारे कोणतीही विशिष्ट कलमे हायलाइट केली गेली नाहीत।", feature1: "झटपट सारांश", feature2: "गुंतागुंतीच्या कलमांचे स्पष्टीकरण", feature3: "परस्परसंवादी প্রশ্নोत्तर", security: "सुरक्षित आणि खाजगी: तुमचे दस्तऐवज सुरक्षितपणे प्रक्रिया केले जातात आणि आमच्या सर्व्हरवर कधीही संग्रहित केले जात नाहीत.", errorPDFParse: "पीडीएफ फाइलमधून मजकुर वाचता आला नाही. ती फक्त-प्रतिमा पीडीएफ किंवा दूषित असू शकते.", langInstruction: "Provide the entire response in Marathi.", fileReady: (count) => `विश्लेषणासाठी ${count} फाइल(ली) तयार आहे. तुम्ही पुढे जाऊ शकता.`, healthTitle: "करार आरोग्य", reExplain: "पुन्हा स्पष्ट करा", askWhy: "का विचारा", emailClause: "ईमेल करा", severityTitle: "कलमाची तीव्रता", severityHigh: "उच्च", severityMedium: "मध्यम", severityLow: "कमी", nextStepsTitle: "पुढील चरण", analysisReport: "विश्लेषण अहवाल", copyReport: "कॉपी", emailReport: "शेअर", historyTitle: "विश्लेषण ইতিহাস", noHistory: "अद्याप कोणताही ইতিহাস नाही. प्रारंभ करण्यासाठी दस्तऐवज বিশ্লেষণ करा.", clearHistory: "इतिहास साफ करा", clearHistoryConfirm: "तुम्ही सर्व ইতিহাস साफ करू इच्छिता याची खात्री आहे का?" },
            ta: { title: "நியாயசாரதி ஏஐ", subtitle: "உங்கள் செயற்கை நுண்ணறிவு சட்ட ஆவண உதவியாளர்.", pastePlaceholder: "உங்கள் சிக்கலான சட்ட ஆவணத்தை இங்கே ஒட்டவும், அல்லது கீழே கோப்புகளைத் தேர்ந்தெடுக்கவும்.", uploadFile: "ஆவணத்தைப் பதிவேற்றுக", useCamera: "கேமராவைப் பயன்படுத்தவும்", demystifyBtn: "ஆவணத்தை டிமிஸ்டிஃபை செய்யவும்", initialTitle: "உங்கள் எளிமைப்படுத்தப்பட்ட சுருக்கம் இங்கே தோன்றும்.", initialSubtitle: "நீங்கள் பின்தொடர் கேள்விகளையும் கேட்கலாம்.", summaryTitle: "ஆவணச் சுருக்கம்", clausesTitle: "முக்கிய உட்பிரிவுகளின் விளக்கங்கள்", chatTitle: "ஒரு கேள்வியைக் கேளுங்கள்", chatPlaceholder: "குறிப்பிட்ட விதிமுறைகள், தேதிகள் அல்லது கடமைகள் பற்றி கேளுங்கள்...", clear: "அழி", errorPasteDoc: "தயவுசெய்து ஒரு ஆவணத்தை ஒட்டவும் அல்லது குறைந்தபட்சம் ஒரு கோப்பைத் தேர்ந்தெடுக்கவும்.", errorFileSupport: "ஆதரிக்கப்படாத கோப்பு வகை. தயவுசெய்து .txt, .pdf, .png, .jpg அல்லது .jpeg கோப்பைப் பதிவேற்றவும்.", errorCameraSupport: "கேமரா ஆதரவு இன்னும் செயல்படுத்தப்படவில்லை. தயவுசெய்து ஒரு கோப்பைத் தேர்ந்தெடுக்கவும்.", errorAIGeneric: "மன்னிக்கவும், என்னால் அதைச் செயல்படுத்த முடியவில்லை. தயவுசெய்து மீண்டும் முயற்சிக்கவும்.", noSummary: "சுருக்கம் எதுவும் உருவாக்க முடியவில்லை.", noClauses: "செயற்கை நுண்ணறிவால் குறிப்பிட்ட உட்பிரிவுகள் எதுவும் முன்னிலைப்படுத்தப்படவில்லை.", feature1: "உடனடி சுருக்கங்கள்", feature2: "சிக்கலான உட்பிரிவு விளக்கங்கள்", feature3: "ஊடாடும் கேள்வி பதில்", security: "பாதுகாப்பானது மற்றும் riêng tư: உங்கள் ஆவணங்கள் பாதுகாப்பாக செயலாக்கப்படுகின்றன மற்றும் எங்கள் சேவையகங்களில் ஒருபோதும் சேமிக்கப்படுவதில்லை.", errorPDFParse: "PDF கோப்பிலிருந்து உரையைப் படிக்க முடியவில்லை. இது படம் മാത്രമുള്ള PDF ஆகவோ அல்லது சிதைந்ததாகவோ இருக்கலாம்.", langInstruction: "Provide the entire response in Tamil.", fileReady: (count) => `பகுப்பாய்விற்கு ${count} கோப்பு(கள்) தயாராக உள்ளது. நீங்கள் தொடரலாம்.`, healthTitle: "ஒப்பந்த ఆరోగ్యం", reExplain: "மீண்டும் விளக்கவும்", askWhy: "ஏன் என்று கேளுங்கள்", emailClause: "மின்னஞ்சல்", severityTitle: " உட்பிரிவு தீவிரம்", severityHigh: "உயர்", severityMedium: "நடுத்தர", severityLow: "குறைந்த", nextStepsTitle: "அடுத்த படிகள்", analysisReport: "பகுப்பாய்வு அறிக்கை", copyReport: "நகலெடு", emailReport: "பகிர்", historyTitle: "பகுப்பாய்வு வரலாறு", noHistory: "இன்னும் வரலாறு இல்லை. தொடங்க ஒரு ஆவணத்தை பகுப்பாய்வு செய்யவும்.", clearHistory: "வரலாற்றை ತೆರವುಗೊಳಿಸಿ", clearHistoryConfirm: "நீங்கள் எல்லா வரலாற்றையும் ತೆರವುಗೊಳಿಸಲು ಖಚಿತವಾಗಿ ಬಯಸುತ್ತೀರಾ?" },
            ml: { title: "ന്യായസാരഥി AI", subtitle: "നിങ്ങളുടെ AI നിയമ പ്രമാണ സഹായി.", pastePlaceholder: "നിങ്ങളുടെ സങ്കീർണ്ണമായ നിയമ പ്രമാണം ഇവിടെ ഒട്ടിക്കുക, അല്ലെങ്കിൽ താഴെ ഫയലുകൾ തിരഞ്ഞെടുക്കുക.", uploadFile: "പ്രമാണം അപ്‌ലോഡ് ചെയ്യുക", useCamera: "ക്യാമറ ഉപയോഗിക്കുക", demystifyBtn: "പ്രമാണം ലളിതമാക്കുക", initialTitle: "നിങ്ങളുടെ ലളിതമായ സംഗ്രഹം ഇവിടെ ദൃശ്യമാകും.", initialSubtitle: "നിങ്ങൾക്ക് തുടർചോദ്യങ്ങൾ ചോദിക്കാനും കഴിയും.", summaryTitle: "പ്രമാണ സംഗ്രഹം", clausesTitle: "പ്രധാന വ്യവസ്ഥകളുടെ വിശദീകരണങ്ങൾ", chatTitle: "ഒരു ചോദ്യം ചോദിക്കുക", chatPlaceholder: "നിർദ്ദിഷ്ട പദങ്ങൾ, തീയതികൾ, അല്ലെങ്കിൽ ബാധ്യതകളെക്കുറിച്ച് ചോദിക്കുക...", clear: "മായ്ക്കുക", errorPasteDoc: "ദയവായി ഒരു പ്രമാണം ഒട്ടിക്കുക അല്ലെങ്കിൽ കുറഞ്ഞത് ഒരു ഫയലെങ്കിലും തിരഞ്ഞെടുക്കുക.", errorFileSupport: "പിന്തുണയ്ക്കാത്ത ഫയൽ തരം. ദയവായി .txt, .pdf, .png, .jpg അല്ലെങ്കിൽ .jpeg ഫയൽ അപ്‌ലോഡ് ചെയ്യുക.", errorCameraSupport: "ക്യാമറ പിന്തുണ ഇതുവരെ നടപ്പിലാക്കിയിട്ടില്ല. ദയവായി ഒരു ഫയൽ തിരഞ്ഞെടുക്കുക.", errorAIGeneric: "ക്ഷമിക്കണം, എനിക്കത് പ്രോസസ്സ് ചെയ്യാൻ കഴിഞ്ഞില്ല. ദയവായി വീണ്ടും ശ്രമിക്കുക.", noSummary: "സംഗ്രഹം സൃഷ്ടിക്കാൻ കഴിഞ്ഞില്ല.", noClauses: "AI പ്രത്യേക വ്യവസ്ഥകളൊന്നും ഹൈലൈറ്റ് ചെയ്തിട്ടില്ല.", feature1: "തൽക്ഷണ സംഗ്രഹങ്ങൾ", feature2: "സങ്കീർണ്ണമായ വ്യവസ്ഥകളുടെ വിശദീകരണങ്ങൾ", feature3: "സംവേദനാത്മക ചോദ്യോത്തരം", security: "സുരക്ഷിതവും സ്വകാര്യവും: നിങ്ങളുടെ പ്രമാണങ്ങൾ സുരക്ഷിതമായി പ്രോസസ്സ് ചെയ്യുകയും ഞങ്ങളുടെ സെർവറുകളിൽ ഒരിക്കലും സംഭരിക്കാതിരിക്കുകയും ചെയ്യുന്നു.", errorPDFParse: "PDF ഫയലിൽ നിന്ന് ടെക്സ്റ്റ് വായിക്കാൻ കഴിഞ്ഞില്ല. ഇത് ഒരു ഇമേജ്-മാത്രം PDF അല്ലെങ്കിൽ കേടായതാകാം.", langInstruction: "Provide the entire response in Malayalam.", fileReady: (count) => `${count} ഫയലുകൾ വിശകലനത്തിനായി തയ്യാറാണ്. നിങ്ങൾക്ക് തുടരാം.`, healthTitle: "കരാർ ആരോഗ്യം", reExplain: "വീണ്ടും വിശദീകരിക്കുക", askWhy: "എന്തുകൊണ്ടെന്ന് ചോദിക്കുക", emailClause: "ഇമെയിൽ", severityTitle: "വ്യവസ്ഥയുടെ കാഠിന്യം", severityHigh: "ഉയർന്നത്", severityMedium: "ഇടത്തരം", severityLow: "കുറഞ്ഞത്", nextStepsTitle: "അടുത്ത നടപടികൾ", analysisReport: "വിശകലന റിപ്പോർട്ട്", copyReport: "പകർത്തുക", emailReport: "പങ്കിടുക", historyTitle: "വിശകലന ചരിത്രം", noHistory: "ഇതുവരെ ചരിത്രമില്ല. ആരംഭിക്കാൻ ഒരു പ്രമാണം വിശകലനം ചെയ്യുക.", clearHistory: "ചരിത്രം മായ്ക്കുക", clearHistoryConfirm: "നിങ്ങൾക്ക് എല്ലാ ചരിത്രവും മായ്ക്കാൻ താൽപ്പര്യമുണ്ടെന്ന് ഉറപ്പാണോ?" }
        };

        // --- Language & Theme ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            languageSelector.value = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key] && typeof translations[lang][key] !== 'function') {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
            clearBtn.title = translations[lang].clear;
            renderSelectedFiles(); // Re-render status text in new language
        }

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

        languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

        // --- UI Control ---
        function showState(state) {
            const clauseSeveritySection = document.getElementById('clauseSeveritySection');
            if (state === 'loading') {
                [initialState, resultState, errorMessage].forEach(el => el.classList.add('hidden'));
                loadingState.classList.remove('hidden');
                if(chatSection.classList.contains('hidden')) { // only hide chat if it's not already visible
                     chatSection.classList.add('hidden');
                }
                 exportButtonsContainer.classList.add('hidden');
            } else {
                [initialState, loadingState, resultState, errorMessage].forEach(el => el.classList.add('hidden'));
                if (state === 'result') {
                    resultState.classList.remove('hidden');
                    chatSection.classList.remove('hidden');
                    exportButtonsContainer.classList.remove('hidden');
                } else if (state === 'initial') {
                    initialState.classList.remove('hidden');
                    chatSection.classList.add('hidden');
                    contractHealthSection.classList.add('hidden');
                    clauseSeveritySection.classList.add('hidden');
                    exportButtonsContainer.classList.add('hidden');
                }
            }
        }
        
        function showError(langKey) {
            errorText.textContent = translations[currentLanguage][langKey] || "An unknown error occurred.";
            errorMessage.classList.remove('hidden');
        }

        // --- API Call Logic ---
        async function callGeminiAPI(contents, retries = 3, delay = 1000) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents }),
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiAPI(contents, retries - 1, delay * 2);
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    throw new Error("Invalid AI response structure.");
                }
            } catch (error) {
                console.error("API Call failed:", error);
                showError('errorAIGeneric');
                return null;
            }
        }

        async function processAndDemystify() {
            const textInput = documentInput.value.trim();
            if (!textInput && selectedFiles.length === 0) {
                showError("errorPasteDoc");
                return;
            }

            documentInput.disabled = true;
            demystifyBtn.disabled = true;
            showState('loading');
            
            const langInstruction = translations[currentLanguage].langInstruction || "Provide the entire response in English.";
            let combinedTextForContext = textInput;
            originalDocument = textInput;
            
            const apiParts = [];
            
            let instructionPrompt = `Analyze the following legal document(s). ${langInstruction}\nProvide the output in four distinct sections in this exact order.\nFirst, create a section titled "### Contract Health". Provide a single-word rating from this list: [Good, Standard, Caution]. Then, on a new line, provide a one-sentence justification for this rating.\nSecond, create a section titled "### Next Steps". Provide a bulleted list of 2-3 clear, actionable recommendations for the user.\nThird, create a section titled "### Summary".\nFourth, create a section titled "### Key Clauses", identifying 3-4 crucial clauses. For each clause, provide a title using markdown bold like **Clause Title**, followed by a severity rating in brackets from this list: [High], [Medium], [Low]. Then, on a new line, provide the explanation.\n`;

            if(textInput){
                instructionPrompt += `Here is text that was pasted:\n---\n${textInput}\n---\n`;
            }
            apiParts.push({ text: instructionPrompt });


            try {
                 for (const file of selectedFiles) {
                    if (file.type.startsWith('image/')) {
                        const base64Data = await readFileAsBase64(file);
                        apiParts.push({
                            inlineData: {
                                mimeType: file.type,
                                data: base64Data
                            }
                        });
                    } else if (file.type === 'text/plain' || file.type === 'application/pdf') {
                        const text = await processTextFile(file);
                        combinedTextForContext += '\n\n--- (From ' + file.name + ') ---\n' + text;
                        apiParts.push({ text: `Here is the content from the file "${file.name}":\n---\n${text}\n---` });
                    }
                }

                originalDocument = combinedTextForContext; 
                
                const aiResponse = await callGeminiAPI([{ parts: apiParts }]);
                
                if (aiResponse) {
                    currentAnalysis = {
                        id: Date.now(),
                        title: originalDocument.substring(0, 40) + '...',
                        date: new Date().toLocaleString(),
                        response: aiResponse
                    };
                    saveHistory(currentAnalysis);
                    parseAndDisplayResponse(aiResponse);
                    showState('result');
                } else {
                    showState('initial');
                }

            } catch (error) {
                console.error("File processing error:", error);
                showState('initial');
            } finally {
                documentInput.disabled = false;
                demystifyBtn.disabled = false;
            }
        }

        // --- File Handling ---
        function renderSelectedFiles() {
            fileListContainer.innerHTML = '';
            if (selectedFiles.length > 0) {
                selectedFiles.forEach((file, index) => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'flex items-center justify-between bg-gray-500/10 p-2 rounded-md text-sm';
                    fileElement.innerHTML = `
                        <span class="truncate pr-2">${file.name}</span>
                        <button data-index="${index}" class="remove-file-btn text-red-500 hover:text-red-700 dark:hover:text-red-400 flex-shrink-0 font-bold">&times;</button>
                    `;
                    fileListContainer.appendChild(fileElement);
                });
                const statusText = translations[currentLanguage].fileReady;
                fileStatus.textContent = statusText ? statusText(selectedFiles.length) : `${selectedFiles.length} file(s) ready.`;
            } else {
                fileStatus.textContent = '';
            }
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderSelectedFiles();
        }

        async function processTextFile(file) {
            return new Promise((resolve, reject) => {
                if (file.type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file);
                } else if (file.type === 'application/pdf') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
                    const reader = new FileReader();
                    reader.onload = async function() {
                        try {
                            const typedarray = new Uint8Array(this.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                            }
                            resolve(fullText.trim());
                        } catch (pdfError) {
                            console.error('Error parsing PDF content:', pdfError);
                            showError('errorPDFParse');
                            reject(pdfError);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.toString().split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- Event Handlers ---
        demystifyBtn.addEventListener('click', processAndDemystify);
        
        clearBtn.addEventListener('click', () => {
            documentInput.value = '';
            originalDocument = '';
            chatHistory.innerHTML = '';
            selectedFiles = [];
            renderSelectedFiles();
            showState('initial');
        });

        async function handleChatSubmit() {
            const userQuery = chatInput.value.trim();
            if (!userQuery) return;

            appendChatMessage(userQuery, 'user');
            chatInput.value = '';
            appendChatMessage('...', 'ai', true); // Typing indicator

            const langInstruction = translations[currentLanguage].langInstruction || "Respond in English.";
            const prompt = `Based on the following legal document(s), answer the user's question. ${langInstruction}\n\nDOCUMENT CONTEXT:\n---\n${originalDocument}\n---\n\nQUESTION: "${userQuery}"`;

            const aiResponse = await callGeminiAPI([{ parts: [{ text: prompt }] }]);

            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.parentElement.remove();

            if (aiResponse) {
                appendChatMessage(aiResponse, 'ai');
            } else {
                appendChatMessage(translations[currentLanguage].errorAIGeneric, 'ai');
            }
        }
        
        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (!files) return;
            selectedFiles.push(...Array.from(files));
            renderSelectedFiles();
            fileInput.value = ''; // Reset for same-file upload
        });

        fileListContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-file-btn')) {
                const index = parseInt(event.target.getAttribute('data-index'), 10);
                removeFile(index);
            }
        });
        
        sendBtn.addEventListener('click', handleChatSubmit);
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleChatSubmit(); } });
        
        // --- Clause Actions Handlers ---
        function handleEmailClause(title, explanation) {
            const subject = `Query regarding legal clause: ${title}`;
            const body = `Hello,\n\nPlease find the details of the following legal clause below:\n\nClause Title: ${title}\n\nExplanation:\n${explanation}\n\nThank you.`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        async function handleReExplain(title, originalExplanation, explanationElement) {
            const originalText = explanationElement.textContent;
            explanationElement.textContent = 'Re-explaining...';
            explanationElement.classList.add('opacity-50');

            const langInstruction = translations[currentLanguage].langInstruction || "Respond in English.";
            const prompt = `Within the context of a legal document, re-explain the following clause in a different way. Be concise and clear. ${langInstruction}\n\nCLAUSE TITLE: ${title}\n\nORIGINAL EXPLANATION: ${originalExplanation}\n\nNEW EXPLANATION:`;
            
            const aiResponse = await callGeminiAPI([{ parts: [{ text: prompt }] }]);
            
            explanationElement.classList.remove('opacity-50');
            if (aiResponse) {
                explanationElement.textContent = aiResponse;
            } else {
                explanationElement.textContent = originalText; // Revert on error
                showError('errorAIGeneric');
            }
        }

        async function handleAskWhy(title, explanation, contentContainer) {
            const existingWhy = contentContainer.querySelector('.why-explanation');
            if (existingWhy) {
                existingWhy.remove(); // Remove old one if it exists
            }

            const whyContainer = document.createElement('div');
            whyContainer.className = 'why-explanation mt-2 pt-2 border-t border-gray-200/50 dark:border-gray-700/50';
            whyContainer.innerHTML = `<p class="text-xs text-gray-500 animate-pulse">Explaining significance...</p>`;
            contentContainer.appendChild(whyContainer);

            const langInstruction = translations[currentLanguage].langInstruction || "Respond in English.";
            const prompt = `Based on the following legal document context, explain WHY the clause titled "${title}" is important. What are its implications for the parties involved? Be concise. ${langInstruction}\n\nDOCUMENT CONTEXT:\n---\n${originalDocument}\n---\n\nCLAUSE TO ANALYZE:\nTitle: ${title}\nExplanation: ${explanation}`;
            
            const aiResponse = await callGeminiAPI([{ parts: [{ text: prompt }] }]);
            
            if (aiResponse) {
                whyContainer.innerHTML = `<strong class="text-sm text-purple-700 dark:text-purple-400">Why it's important:</strong><p class="text-sm text-gray-600 dark:text-gray-400">${aiResponse}</p>`;
            } else {
                whyContainer.remove(); // Remove the container on error
                showError('errorAIGeneric');
            }
        }


        // --- Response Parsing & Display ---
        function parseAndDisplayResponse(response) {
            const healthMatch = response.match(/### Contract Health\s*([\s\S]*?)(?=### Next Steps|$)/i);
            const nextStepsMatch = response.match(/### Next Steps\s*([\s\S]*?)(?=### Summary|$)/i);
            const summaryMatch = response.match(/### Summary\s*([\s\S]*?)(?=### Key Clauses|$)/i);
            const clausesMatch = response.match(/### Key Clauses\s*([\s\S]*)/i);
            const clauseSeveritySection = document.getElementById('clauseSeveritySection');
            const severityCard = document.getElementById('severityCard');
            const nextStepsSection = document.getElementById('nextStepsSection');

            // Handle Contract Health
            if (healthMatch) {
                contractHealthSection.classList.remove('hidden');
                const healthContent = healthMatch[1].trim().split('\n');
                const rating = healthContent[0] || 'Standard';
                const justification = healthContent[1] || 'No specific risks or benefits identified.';
                
                healthRating.textContent = rating;
                healthJustification.textContent = justification;
                
                // Reset classes
                healthCard.className = 'p-4 rounded-lg flex items-start space-x-4';
                healthRating.className = 'font-bold text-xl';

                switch(rating.toLowerCase()) {
                    case 'good':
                        healthCard.classList.add('bg-green-500/10');
                        healthRating.classList.add('text-green-800', 'dark:text-green-300');
                        healthJustification.classList.add('text-green-700', 'dark:text-green-400');
                        healthIcon.innerHTML = `<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                        break;
                    case 'caution':
                        healthCard.classList.add('bg-red-500/10');
                        healthRating.classList.add('text-red-800', 'dark:text-red-300');
                        healthJustification.classList.add('text-red-700', 'dark:text-red-400');
                        healthIcon.innerHTML = `<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
                        break;
                    default: // Standard
                        healthCard.classList.add('bg-yellow-500/10');
                        healthRating.classList.add('text-yellow-800', 'dark:text-yellow-300');
                        healthJustification.classList.add('text-yellow-700', 'dark:text-yellow-400');
                        healthIcon.innerHTML = `<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                        break;
                }
            } else {
                 contractHealthSection.classList.add('hidden');
            }

            // Handle Next Steps
            if (nextStepsMatch) {
                nextStepsSection.classList.remove('hidden');
                const stepsContent = nextStepsMatch[1].trim();
                const steps = stepsContent.split('\n').filter(s => s.trim().startsWith('*') || s.trim().startsWith('-'));
                nextStepsContainer.innerHTML = steps.map(step => {
                    return `<li class="flex items-start space-x-3"><svg class="w-5 h-5 text-green-500 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-gray-600 dark:text-gray-300">${step.substring(1).trim()}</span></li>`;
                }).join('');
            } else {
                nextStepsSection.classList.add('hidden');
            }

            summaryText.textContent = summaryMatch ? summaryMatch[1].trim() : translations[currentLanguage].noSummary;
            
            clausesContainer.innerHTML = '';
            severityCard.innerHTML = '';

            if (clausesMatch) {
                clauseSeveritySection.classList.remove('hidden');
                const clausesText = clausesMatch[1].trim();
                const clauseItems = clausesText.split(/(?=\n\*\*.*?\*\*)/).filter(c => c.trim() !== '');
                const severityCounts = { High: 0, Medium: 0, Low: 0 };

                clauseItems.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white/60 dark:bg-gray-800/60 p-5 border border-gray-200/50 dark:border-gray-700/50 rounded-lg shadow-sm flex flex-col';
                    
                    const mainContent = document.createElement('div');
                    mainContent.className = 'flex items-start space-x-4';

                    const iconContainer = document.createElement('div');
                    iconContainer.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center';
                    iconContainer.innerHTML = `<svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>`;
                    
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'flex-grow';

                    const titleMatch = item.match(/\*\*(.*?)\*\*/);
                    const severityMatch = item.match(/\[(High|Medium|Low)\]/i);
                    const title = titleMatch ? titleMatch[1] : 'Key Point';
                    const severity = severityMatch ? severityMatch[1] : 'Medium';
                    
                    if (severity.toLowerCase() === 'high') severityCounts.High++;
                    else if (severity.toLowerCase() === 'medium') severityCounts.Medium++;
                    else if (severity.toLowerCase() === 'low') severityCounts.Low++;
                    
                    const explanation = item.replace(/\*\*(.*?)\*\*(\s*\[(High|Medium|Low)\])?/i, '').trim();

                    let severityBadge = '';
                    if (severity) {
                        let colorClasses = '';
                        switch(severity.toLowerCase()) {
                            case 'high': colorClasses = 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'; break;
                            case 'medium': colorClasses = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'; break;
                            case 'low': colorClasses = 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300'; break;
                        }
                        severityBadge = `<span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${colorClasses}">${severity}</span>`;
                    }
                    
                    contentContainer.innerHTML = `
                        <div class="flex items-center justify-between">
                           <h4 class="font-semibold text-purple-800 dark:text-purple-300">${title}</h4>
                           ${severityBadge}
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 mt-1 text-sm leading-relaxed">${explanation}</p>
                    `;
                    
                    mainContent.appendChild(iconContainer);
                    mainContent.appendChild(contentContainer);
                    card.appendChild(mainContent);

                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'mt-4 pt-3 border-t border-gray-200/50 dark:border-gray-700/50 flex items-center space-x-2';
                    const buttonBaseClasses = 'flex items-center space-x-1.5 px-3 py-1.5 rounded-full text-xs font-semibold transition-colors';
                    const buttonColorClasses = 'text-gray-600 bg-gray-100 hover:bg-gray-200 dark:text-gray-300 dark:bg-gray-700/50 dark:hover:bg-gray-700';

                    actionsContainer.innerHTML = `
                        <button class="re-explain-btn ${buttonBaseClasses} ${buttonColorClasses}">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691L7.5 12.25m0 0l-3.182 3.182M12 12l3.182-3.182"></path></svg>
                            <span data-lang-key="reExplain">${translations[currentLanguage].reExplain}</span>
                        </button>
                        <button class="ask-why-btn ${buttonBaseClasses} ${buttonColorClasses}">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span data-lang-key="askWhy">${translations[currentLanguage].askWhy}</span>
                        </button>
                        <button class="email-clause-btn ${buttonBaseClasses} ${buttonColorClasses}">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span data-lang-key="emailClause">${translations[currentLanguage].emailClause}</span>
                        </button>
                    `;

                    const explanationElement = contentContainer.querySelector('p');
                    actionsContainer.querySelector('.re-explain-btn').addEventListener('click', () => handleReExplain(title, explanation, explanationElement));
                    actionsContainer.querySelector('.ask-why-btn').addEventListener('click', () => handleAskWhy(title, explanation, contentContainer));
                    actionsContainer.querySelector('.email-clause-btn').addEventListener('click', () => handleEmailClause(title, explanation));

                    card.appendChild(actionsContainer);
                    clausesContainer.appendChild(card);
                });

                const severities = [
                    { level: 'High', count: severityCounts.High, color: 'red' },
                    { level: 'Medium', count: severityCounts.Medium, color: 'yellow' },
                    { level: 'Low', count: severityCounts.Low, color: 'green' }
                ];
                severities.forEach(s => {
                    if (s.count > 0) {
                         // Add separator if not the first item
                        if (severityCard.innerHTML !== '') {
                             const separator = document.createElement('span');
                             separator.className = 'text-gray-300 dark:text-gray-600';
                             separator.innerHTML = '&middot;';
                             severityCard.appendChild(separator);
                        }

                         const severityEl = document.createElement('div');
                         severityEl.className = 'flex items-center space-x-2';
                         severityEl.innerHTML = `
                            <span class="font-bold text-lg text-${s.color}-600 dark:text-${s.color}-400">${s.count}</span>
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400">${translations[currentLanguage]['severity' + s.level]}</span>
                         `;
                         severityCard.appendChild(severityEl);
                    }
                });


            } else {
                clausesContainer.innerHTML = `<p class="text-gray-500">${translations[currentLanguage].noClauses}</p>`;
                clauseSeveritySection.classList.add('hidden');
            }
             renderExportButtons();
        }

        function appendChatMessage(message, sender, isTyping = false) {
             const messageWrapper = document.createElement('div');
             messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
             const messageBubble = document.createElement('div');
             messageBubble.className = `max-w-xs lg:max-w-md p-3 ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
             messageBubble.textContent = message;
             if(isTyping) {
                messageBubble.id = 'typing-indicator';
                messageBubble.classList.add('animate-pulse');
             }
             messageWrapper.appendChild(messageBubble);
             chatHistory.appendChild(messageWrapper);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // --- History Logic ---
        function getHistory() {
            return JSON.parse(localStorage.getItem('nyaySarthiHistory') || '[]');
        }

        function saveHistory(analysis) {
            const history = getHistory();
            history.unshift(analysis);
            localStorage.setItem('nyaySarthiHistory', JSON.stringify(history.slice(0, 50))); // limit to 50 entries
            renderHistory();
        }
        
        function renderHistory() {
            const history = getHistory();
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = `<p class="text-center text-gray-500 text-sm" data-lang-key="noHistory">${translations[currentLanguage].noHistory}</p>`;
                return;
            }
            history.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 rounded-lg bg-gray-100 dark:bg-gray-700/50 hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer flex justify-between items-start';
                itemEl.innerHTML = `
                    <div>
                        <p class="font-semibold text-sm truncate">${item.title}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${item.date}</p>
                    </div>
                    <button data-index="${index}" class="delete-history-btn text-red-500 hover:text-red-700 ml-2 flex-shrink-0">&times;</button>
                `;
                itemEl.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-history-btn')) {
                        viewHistoryItem(index);
                    }
                });
                historyList.appendChild(itemEl);
            });
        }
        
        function viewHistoryItem(index) {
            const history = getHistory();
            const item = history[index];
            if (item) {
                originalDocument = item.title;
                parseAndDisplayResponse(item.response);
                showState('result');
                toggleHistoryPanel();
            }
        }
        
        function deleteHistoryItem(index) {
            let history = getHistory();
            history.splice(index, 1);
            localStorage.setItem('nyaySarthiHistory', JSON.stringify(history));
            renderHistory();
        }

        historyList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-history-btn')) {
                const index = parseInt(e.target.getAttribute('data-index'), 10);
                deleteHistoryItem(index);
            }
        });
        
        function toggleHistoryPanel() {
            const isOpen = historyPanel.classList.contains('open');
            historyPanel.classList.toggle('open');
            historyOverlay.classList.toggle('hidden', isOpen);
        }
        
        historyBtn.addEventListener('click', toggleHistoryPanel);
        closeHistoryBtn.addEventListener('click', toggleHistoryPanel);
        historyOverlay.addEventListener('click', toggleHistoryPanel);
        clearHistoryBtn.addEventListener('click', () => {
             if (confirm(translations[currentLanguage].clearHistoryConfirm)) {
                localStorage.removeItem('nyaySarthiHistory');
                renderHistory();
             }
        });

        // --- Export & Share Logic ---
        function getReportAsText(fullReport = true) {
             if (!fullReport) {
                return document.getElementById('summaryText').textContent;
            }
            let report = `ANALYSIS REPORT - NyaySarthi AI\n============================\n\n`;
            
            const healthRatingText = document.getElementById('healthRating').textContent;
            const healthJustificationText = document.getElementById('healthJustification').textContent;
            report += `CONTRACT HEALTH: ${healthRatingText}\n${healthJustificationText}\n\n`;
            
            const nextSteps = Array.from(document.getElementById('nextStepsContainer').children).map(li => `- ${li.textContent}`).join('\n');
            report += `ACTIONABLE NEXT STEPS:\n${nextSteps}\n\n`;

            const summary = document.getElementById('summaryText').textContent;
            report += `SUMMARY:\n${summary}\n\n`;

            report += `KEY CLAUSES:\n`;
            const clauses = document.getElementById('clausesContainer').children;
            Array.from(clauses).forEach(card => {
                const title = card.querySelector('h4').textContent;
                const severity = card.querySelector('span.text-xs')?.textContent || 'N/A';
                const explanation = card.querySelector('p').textContent;
                report += `\n[${severity}] ${title}\n${explanation}\n`;
            });

            return report;
        }

        function copyReport() {
            const text = getReportAsText();
            navigator.clipboard.writeText(text).then(() => {
                alert('Report copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        async function handleShare() {
            const reportText = getReportAsText();
            const shareData = {
                title: 'NyaySarthi AI Analysis Report',
                text: reportText,
            };
            const emailFallback = () => {
                window.location.href = `mailto:?subject=${encodeURIComponent(shareData.title)}&body=${encodeURIComponent(shareData.text)}`;
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.error("Share failed, falling back to email:", err);
                    if (err.name !== 'AbortError') {
                        emailFallback();
                    }
                }
            } else {
                 emailFallback();
            }
        }
        
        function renderExportButtons() {
            exportButtonsContainer.innerHTML = `
                <button id="copy-btn" title="${translations[currentLanguage].copyReport}" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors"><svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>
                <button id="share-btn" title="${translations[currentLanguage].emailReport}" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors"><svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.862 13.342 9 13.194 9 13s-.138-.342-.316-.342C8.438 12.658 8 12.28 8 11.737c0-.543.438-.921.684-.921.178 0 .316.148.316.342 0 .194-.138.342-.316.342a1 1 0 110-2c1.316 0 2.316 1.08 2.316 2.263 0 1.183-1 2.013-2.316 2.013C8.438 14.658 8 14.28 8 13.737c0-.543.438-.921.684-.921.178 0 .316.148.316.342 0 .194-.138.342-.316.342a1 1 0 110-2c1.316 0 2.316 1.08 2.316 2.263 0 1.183-1 2.013-2.316 2.013C8.438 15.974 8 15.596 8 15.053c0-.543.438-.921.684-.921.178 0 .316.148.316.342 0 .194-.138.342-.316.342a1 1 0 110-2c1.316 0 2.316 1.08 2.316 2.263 0 1.183-1 2.013-2.316 2.013zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/></path></svg></button>
            `;
            document.getElementById('copy-btn').addEventListener('click', copyReport);
            document.getElementById('share-btn').addEventListener('click', handleShare);
        }

        // --- Initialize ---
        function initializeApp() {
            setLanguage(currentLanguage);
            showState('initial');
            renderHistory();
            
            // Handle splash screen fade out
            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 500); // Match transition duration
            }, 2500); // Splash screen visible for 2.5s
        }

        initializeApp();
    </script>
</body>
</html>

